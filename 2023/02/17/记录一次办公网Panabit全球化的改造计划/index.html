<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>记录一次办公网全球化的改造计划</title><meta name="description" content="混迹在IT行业的小菜鸟"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="背景办公网每次去海外找资料都需要重新连接VPN，或者自己连接自己买的小飞机之类的才可以。但是这种在互联网公司内的话，非常的不友好；为公司工作还要自己花钱买小飞机～
之前尝试过下面这种方式：新增一台海外的机器（新加坡、香港）搭建SS&amp;#x2F;v2ray&amp;#x2F;trojan之类的协议，然后办公网新增一个软路由去连接，通过ACL把部分IP的用户跳转过去；但是这种方式自己家里用用还行，如果想要在企业的办公网来使用的话，人一多就不行，因为所有人都从这个IP出去了，而且每次都需要命令行去操作ACL增加用户，非常的麻烦；
名词介绍


名词
介绍



Panabit
Panabit是国内X86平台单板处理能力最高（双向40G）、在运营商和高校等行业案例过千（X运营商千兆以上规格共计400余台已普遍连续稳定运行至第.."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="YanTao的线上笔记本" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Almighty.Yantao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">记录一次办公网全球化的改造计划</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E4%BB%8B%E7%BB%8D"><span class="toc-text">名词介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Panabit-%E7%9A%84-Iwan"><span class="toc-text">Panabit 的 Iwan</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%90%AD%E5%BB%BApanabit"><span class="toc-text">1、搭建panabit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3"><span class="toc-text">修改端口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-text">上传文件，修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cjoskmc"><span class="toc-text">执行joskmc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%EF%BC%9A-etc-rc-local%EF%BC%8C%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%8B%E4%B8%89%E8%A1%8C"><span class="toc-text">修改：&#x2F;etc&#x2F;rc.local，增加一下三行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%BF%9B%E8%A1%8C%E9%9A%A7%E9%81%93%E9%85%8D%E7%BD%AE%EF%BC%88%E6%B5%B7%E5%A4%96%EF%BC%89"><span class="toc-text">2、进行隧道配置（海外）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E3%80%81%E7%99%BB%E5%BD%95WEB%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1%E6%96%B9%E5%90%91"><span class="toc-text">(1)、登录WEB页面，修改网卡方向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E3%80%81%E5%88%9B%E5%BB%BAWAN%E7%BA%BF%E8%B7%AF"><span class="toc-text">(2)、创建WAN线路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E3%80%81%E5%88%9B%E5%BB%BAIWAN%E8%BF%9E%E6%8E%A5%E8%B4%A6%E5%8F%B7"><span class="toc-text">(3)、创建IWAN连接账号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E3%80%81%E5%88%9B%E5%BB%BAiWAN%E6%9C%8D%E5%8A%A1"><span class="toc-text">(4)、创建iWAN服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E3%80%81%E5%88%9B%E5%BB%BA%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1"><span class="toc-text">(5)、创建策略路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%EF%BC%88%E5%8A%9E%E5%85%AC%E7%BD%91%EF%BC%89"><span class="toc-text">3、客户端配置（办公网）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E3%80%81%E6%96%B0%E5%BB%BAWAN%E7%BA%BF%E8%B7%AF"><span class="toc-text">(1)、新建WAN线路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E3%80%81%E8%AE%BE%E7%BD%AEDNS%E7%89%B5%E5%BC%95"><span class="toc-text">(2)、设置DNS牵引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E3%80%81%E8%AE%BE%E7%BD%AE%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1"><span class="toc-text">(3)、设置策略路由</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E4%BB%B6"><span class="toc-text">附件</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%8A%9E%E5%85%AC%E7%BD%91"><i class="tag post-item-tag">办公网</i></a><a href="/tags/%E5%85%A8%E7%90%83%E5%8C%96"><i class="tag post-item-tag">全球化</i></a><a href="/tags/%E5%85%A8%E7%90%83%E5%8A%9E%E5%85%AC"><i class="tag post-item-tag">全球办公</i></a><a href="/tags/%E5%9B%BD%E9%99%85%E5%8C%96"><i class="tag post-item-tag">国际化</i></a><a href="/tags/Panabit"><i class="tag post-item-tag">Panabit</i></a><a href="/tags/iwan"><i class="tag post-item-tag">iwan</i></a><a href="/tags/sd-wan"><i class="tag post-item-tag">sd-wan</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">记录一次办公网全球化的改造计划</h1><time class="has-text-grey" datetime="2023-02-16T16:00:00.000Z">2023-02-17</time><article class="mt-2 post-content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>办公网每次去海外找资料都需要重新连接VPN，或者自己连接自己买的小飞机之类的才可以。但是这种在互联网公司内的话，非常的不友好；为公司工作还要自己花钱买小飞机～</p>
<p>之前尝试过下面这种方式：<br>新增一台海外的机器（新加坡、香港）搭建SS&#x2F;v2ray&#x2F;trojan之类的协议，然后办公网新增一个软路由去连接，通过ACL把部分IP的用户跳转过去；<br>但是这种方式自己家里用用还行，如果想要在企业的办公网来使用的话，人一多就不行，因为所有人都从这个IP出去了，而且每次都需要命令行去操作ACL增加用户，非常的麻烦；</p>
<h1 id="名词介绍"><a href="#名词介绍" class="headerlink" title="名词介绍"></a>名词介绍</h1><table>
<thead>
<tr>
<th>名词</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>Panabit</td>
<td>Panabit是国内X86平台单板处理能力最高（双向40G）、在运营商和高校等行业案例过千（X运营商千兆以上规格共计400余台已普遍连续稳定运行至第7年），实时对超过3TB的网络带宽进行DPI识别与优化服务、并针对中小企业提供免费版本（软件形态），是以DPI为核心优势并发展起来的专业、上线效果好、性价比高的新一代应用网关。进入2014年，实际支持国内应用协议超过800种，并已集成路由、负载均衡、认证、一拖N检测、移动终端识别、DNS管控、HTTP管控、日志审计等实用功能于一体。</td>
</tr>
</tbody></table>
<h1 id="Panabit-的-Iwan"><a href="#Panabit-的-Iwan" class="headerlink" title="Panabit 的 Iwan"></a>Panabit 的 Iwan</h1><p>为了解决前面的这种方式，决定测试使用 Panabit 的 Iwan 的方式，也就是所谓的 Panabit 的 <code>SD-WAN</code>；</p>
<ul>
<li>重连速度很快：<br>        比L2TP的要快一个数量级，L2TP要重连，需要有几十次交互，而我们只需要一次即可  </li>
<li>客户端不受底层承载线路IP变化影响：<br>        当底层承载线路（比如PPPOE拨号线路）的IP地址发生变化时，不会影响iWAN隧道，iWAN隧道不会中断，保证通信正常进行；<br>        因为很多用户是通过PPPOE拨号线路出去的，PPPOE拨号线路重拨时一般会改变IP地址，如果用L2TP的话，那么这个L2TP会话就要重建；<br>        而用iWAN的话，现有的会话可以照常使用，不需要做任何改变；  </li>
<li>传输效率高：<br>        iWAN的包头很小，只有8个字节，而且在后续版本里，我们会压缩IP报文头，这样可以继续减少额外报文头的大小，所以能大幅度提升传输效率；<br>        如果用国际线路的话，节省下来的流量费用都是很可观的；  </li>
<li>抗干扰：<br>        不像L2TP，中间人可以直接发包TERMINATE，iWAN控制命令有完整性检查，可以避免中间人攻击。</li>
</ul>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="1、搭建panabit"><a href="#1、搭建panabit" class="headerlink" title="1、搭建panabit"></a>1、搭建panabit</h2><p>记得服务器申请2H的，1H需要需改核心，非常麻烦<br>下载Linux系统文件：文末<br>上传文件到root根目录下</p>
<pre><code class="bash">tar -xzf PanabitFREE_SUIr2p3_20220413_Linux3.tar.gz
cd PanabitFREE_SUIr2p3_20220413_Linux3
# 输入以下命令进行安装
./ipeinstall
</code></pre>
<p>修改<code>/etc/PG.conf</code>文件<br>因为是单网口，所以数据口和管理口都需要配置成eth0，后面不要加任何东西</p>
<pre><code class="bash">DATA_PORTS 修改成：DATA_PORTS=&quot;eth0&quot;
</code></pre>
<h3 id="修改端口"><a href="#修改端口" class="headerlink" title="修改端口"></a>修改端口</h3><h4 id="上传文件，修改配置"><a href="#上传文件，修改配置" class="headerlink" title="上传文件，修改配置"></a>上传文件，修改配置</h4><p>需要上传一个joskmc文件（文件在文末）<br>在<code>/etc/PG.conf</code>中新增一下一行</p>
<pre><code class="bash">HTTPS_PORT=2194
</code></pre>
<h4 id="执行joskmc"><a href="#执行joskmc" class="headerlink" title="执行joskmc"></a>执行joskmc</h4><pre><code class="bash">/root/joskmc tcp 2194
</code></pre>
<h4 id="修改：-etc-rc-local，增加一下三行"><a href="#修改：-etc-rc-local，增加一下三行" class="headerlink" title="修改：/etc/rc.local，增加一下三行"></a>修改：<code>/etc/rc.local</code>，增加一下三行</h4><pre><code class="bash">sleep 10
/root/joskmc tcp 2194
</code></pre>
<h2 id="2、进行隧道配置（海外）"><a href="#2、进行隧道配置（海外）" class="headerlink" title="2、进行隧道配置（海外）"></a>2、进行隧道配置（海外）</h2><h3 id="1-、登录WEB页面，修改网卡方向"><a href="#1-、登录WEB页面，修改网卡方向" class="headerlink" title="(1)、登录WEB页面，修改网卡方向"></a>(1)、登录WEB页面，修改网卡方向</h3><p>默认账号密码：admin&#x2F;panabit<br>系统概况 → 网络接口：eth0，修改成对外，只有对外才可以创建WAN线路<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103308.png"/></p>
<h3 id="2-、创建WAN线路"><a href="#2-、创建WAN线路" class="headerlink" title="(2)、创建WAN线路"></a>(2)、创建WAN线路</h3><p>应用路由 → 接口线路：<br>需要注意，Mac地址必须克隆<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/202302171033490.png"/></p>
<h3 id="3-、创建IWAN连接账号"><a href="#3-、创建IWAN连接账号" class="headerlink" title="(3)、创建IWAN连接账号"></a>(3)、创建IWAN连接账号</h3><p>对象管理 → 账号管理 → 组织架构：<br>地址范围：这一块可以自己定一个内网的IP段就可以，不要冲突就好<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103417.png"/><br>地址范围需要把网关地址留出来！！！！！<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103432.png"/><br>对象管理 → 账号管理 → 本地账号：<br>处理用户组需要选择前面创建的用户组，其他的根据实际情况填写<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103454.png"/></p>
<h3 id="4-、创建iWAN服务"><a href="#4-、创建iWAN服务" class="headerlink" title="(4)、创建iWAN服务"></a>(4)、创建iWAN服务</h3><p>应用路由 → iWAN服务 → 服务列表：<br>注意：服务器网关地址要和你前面设置的地址范围要在一块，并且需要排除这个地址的下发<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103517.png"/><br>应用路由 → iWAN服务 → 服务映射：<br>根据配置情况选择即可<br>iWAN使用的是UDP连接，因此端口需要开放UDP<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103531.png"/></p>
<h3 id="5-、创建策略路由"><a href="#5-、创建策略路由" class="headerlink" title="(5)、创建策略路由"></a>(5)、创建策略路由</h3><p>应用路由 → 策略路由：需要添加一条回程的全程路由，要不然DNS牵引、FQ都会失败<br>这里选择iWAN的线路<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103546.png"/></p>
<h2 id="3、客户端配置（办公网）"><a href="#3、客户端配置（办公网）" class="headerlink" title="3、客户端配置（办公网）"></a>3、客户端配置（办公网）</h2><h3 id="1-、新建WAN线路"><a href="#1-、新建WAN线路" class="headerlink" title="(1)、新建WAN线路"></a>(1)、新建WAN线路</h3><p>应用路由 → 接口线路 → WAN线路：按照信息提示填写即可完成iWAN线路配置<br>注意：必须有一个外网的网卡，并且最好把加密开起来<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103622.png"/><br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103634.png"/></p>
<h3 id="2-、设置DNS牵引"><a href="#2-、设置DNS牵引" class="headerlink" title="(2)、设置DNS牵引"></a>(2)、设置DNS牵引</h3><p>应用路由 → DNS管控：海外域名是一个域名群组，可以自己修改<br>主要解决DNS污染问题，要不然可能部分网站会无法访问<br>这里有一个很注意的点，就是你的DNS，访问DNS的链路必须经过PA，否则牵引不会生效<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103653.png"/></p>
<h3 id="3-、设置策略路由"><a href="#3-、设置策略路由" class="headerlink" title="(3)、设置策略路由"></a>(3)、设置策略路由</h3><p>应用路由 → 策略路由：我这边直接拿了飞连的609海外分流IP段进行分流，你也可以自己修改（文末下载）<br>主要为了只有需要海外的才出去，不能把所有的流量全部导出去<br><img src="https://raw.githubusercontent.com/almightyYantao/blog-img/master/20230217103713.png"/></p>
<h1 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h1><p>169IP段： <a target="_blank" rel="noopener" href="https://www.123pan.com/s/cRk7Vv-frSsH">https://www.123pan.com/s/cRk7Vv-frSsH</a> 提取码:NzAF<br>Linux操作系统： <a target="_blank" rel="noopener" href="https://www.123pan.com/s/cRk7Vv-arSsH">https://www.123pan.com/s/cRk7Vv-arSsH</a> 提取码:A5MC<br>joskmc： <a target="_blank" rel="noopener" href="https://www.123pan.com/s/cRk7Vv-BrSsH">https://www.123pan.com/s/cRk7Vv-BrSsH</a> 提取码:kTu9</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2023/02/16/ssTproxyTransparentAgent/" title="ss-tproxy 透明代理的设置方法"><span class="has-text-weight-semibold">下一页: ss-tproxy 透明代理的设置方法</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/almightyYantao"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Almighty.Yantao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>