<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>openvpn-auth（支持企业微信认证&amp;LDAP）</title><meta name="description" content="混迹在IT行业的小菜鸟"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="方案介绍时序图

其中有两个地方需要修改
corpid: 企业微信的企业ID
corpsecret: 拥有通讯录的企业微信的Secret

代码如下package auth
import (
    &amp;quot;io/ioutil&amp;quot;
    &amp;quot;log&amp;quot;
    &amp;quot;net/http&amp;quot;
    &amp;quot;strconv&amp;quot;
    &amp;quot;github.com/tidwall/gjson&amp;quot;
)
func GetAccessToken() string &amp;#123;
    return GetWecomToken()
&amp;#125;
// 从企业微信获取Token
func GetWecomToken() string &amp;#123;
   .."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="YanTao的线上笔记本" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Almighty.Yantao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">openvpn-auth（支持企业微信认证&amp;LDAP）</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="toc-text">方案介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-text">时序图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%B8%AD%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%9C%B0%E6%96%B9%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9"><span class="toc-text">其中有两个地方需要修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="toc-text">代码如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-text">加解密方式</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/openvpn"><i class="tag post-item-tag">openvpn</i></a><a href="/tags/openvpn-auth"><i class="tag post-item-tag">openvpn-auth</i></a><a href="/tags/wecom"><i class="tag post-item-tag">wecom</i></a><a href="/tags/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1"><i class="tag post-item-tag">企业微信</i></a><a href="/tags/%E8%AE%A4%E8%AF%81"><i class="tag post-item-tag">认证</i></a><a href="/tags/ldap"><i class="tag post-item-tag">ldap</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">openvpn-auth（支持企业微信认证&amp;LDAP）</h1><time class="has-text-grey" datetime="2022-12-12T16:00:00.000Z">2022-12-13</time><article class="mt-2 post-content"><h2 id="方案介绍"><a href="#方案介绍" class="headerlink" title="方案介绍"></a>方案介绍</h2><h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><img src="/2022/12/13/openvpn/openvpn-auth/image2022-12-12_20-11-38.png" class="" alt="openvpn-auth 时序图">

<h2 id="其中有两个地方需要修改"><a href="#其中有两个地方需要修改" class="headerlink" title="其中有两个地方需要修改"></a>其中有两个地方需要修改</h2><ul>
<li><code>corpid</code>: 企业微信的企业ID</li>
<li><code>corpsecret</code>: 拥有通讯录的企业微信的Secret</li>
</ul>
<h2 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h2><pre><code class="go">package auth
import (
    &quot;io/ioutil&quot;
    &quot;log&quot;
    &quot;net/http&quot;
    &quot;strconv&quot;
    &quot;github.com/tidwall/gjson&quot;
)
func GetAccessToken() string &#123;
    return GetWecomToken()
&#125;
// 从企业微信获取Token
func GetWecomToken() string &#123;
    //创建一个请求
    req, err := http.NewRequest(&quot;GET&quot;, &quot;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=corpid&amp;corpsecret=corpsecret&quot;, nil)
    if err != nil &#123;
        log.Println(&quot;NewRquest:&quot;, err)
    &#125;
    client := &amp;http.Client&#123;&#125;
    //设置请求头
    req.Header.Set(&quot;Content-Type&quot;, &quot;application/json; charset=utf-8&quot;)
    //发送请求
    resp, err := client.Do(req)
    //关闭请求
    defer resp.Body.Close()
    body, err := ioutil.ReadAll(resp.Body)
    access_token := gjson.Get(string(body), &quot;access_token&quot;)
    return access_token.Str
&#125;
// 获取员工信息
func WeComAuth(userId string) bool &#123;
    //创建一个请求
    req, err := http.NewRequest(&quot;GET&quot;, `https://qyapi.weixin.qq.com/cgi-bin/user/get?access_token=`+GetAccessToken()+`&amp;userid=`+userId, nil)
    if err != nil &#123;
        log.Println(&quot;NewRquest:&quot;, err)
    &#125;
    client := &amp;http.Client&#123;&#125;
    //设置请求头
    req.Header.Set(&quot;Content-Type&quot;, &quot;application/json; charset=utf-8&quot;)
    //发送请求
    resp, err := client.Do(req)
    //关闭请求
    defer resp.Body.Close()
    body, err := ioutil.ReadAll(resp.Body)
    errcode := gjson.Get(string(body), &quot;errcode&quot;)
    int, err := strconv.Atoi(errcode.Str)
    return int == 0
&#125;
</code></pre>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><p>修改<code>/etc/openvpn/server.conf</code>的验证方式，可以吧其他的验证去掉</p>
<pre><code class="shell">auth-user-pass-verify /etc/openvpn/openvpn-wecom-password via-file
</code></pre>
<h2 id="加解密方式"><a href="#加解密方式" class="headerlink" title="加解密方式"></a>加解密方式</h2><p>因为用到了客户端传过来的时候的加密方式，因此两边的加密方式必须一致</p>
<pre><code class="go">package util
import (
    &quot;bytes&quot;
    basicAES &quot;crypto/aes&quot;
    &quot;crypto/cipher&quot;
    &quot;encoding/base64&quot;
)
type Aes struct &#123;
    securityKey []byte
    iv          []byte
&#125;
/**
 * constructor
 */
func AesTool() *Aes &#123;
    return &amp;Aes&#123;[]byte(&quot;123&quot;), []byte(&quot;123&quot;)&#125;
&#125;
/**
 * 加密
 * @param string $plainText 明文
 * @return bool|string
 */
func (a Aes) Encrypt(plainText string) (string, error) &#123;
    block, err := basicAES.NewCipher(a.securityKey)
    if err != nil &#123;
        return &quot;&quot;, err
    &#125;
    plainTextByte := []byte(plainText)
    blockSize := block.BlockSize()
    plainTextByte = AddPKCS7Padding(plainTextByte, blockSize)
    cipherText := make([]byte, len(plainTextByte))
    mode := cipher.NewCBCEncrypter(block, a.iv)
    mode.CryptBlocks(cipherText, plainTextByte)
    return base64.StdEncoding.EncodeToString(cipherText), nil
&#125;
/**
 * 解密
 * @param string $cipherText 密文
 * @return bool|string
 */
func (a Aes) Decrypt(cipherText string) (string, error) &#123;
    block, err := basicAES.NewCipher(a.securityKey)
    if err != nil &#123;
        return &quot;&quot;, err
    &#125;
    cipherDecodeText, decodeErr := base64.StdEncoding.DecodeString(cipherText)
    if decodeErr != nil &#123;
        return &quot;&quot;, decodeErr
    &#125;
    mode := cipher.NewCBCDecrypter(block, a.iv)
    originCipherText := make([]byte, len(cipherDecodeText))
    mode.CryptBlocks(originCipherText, cipherDecodeText)
    originCipherText = StripPKSC7Padding(originCipherText)
    return string(originCipherText), nil
&#125;
/**
 * 填充算法
 * @param string $source
 * @return string
 */
func AddPKCS7Padding(ciphertext []byte, blockSize int) []byte &#123;
    padding := blockSize - len(ciphertext)%blockSize
    paddingText := bytes.Repeat([]byte&#123;byte(padding)&#125;, padding)
    return append(ciphertext, paddingText...)
&#125;
/**
 * 移去填充算法
 * @param string $source
 * @return string
 */
func StripPKSC7Padding(cipherText []byte) []byte &#123;
    length := len(cipherText)
    unpadding := int(cipherText[length-1])
    return cipherText[:(length - unpadding)]
&#125;
</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/12/13/haproxy-load/" title="通过 Haproxy 实现 Shadowshadows 负载均衡"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 通过 Haproxy 实现 Shadowshadows 负载均衡</span></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/almightyYantao"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Almighty.Yantao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>