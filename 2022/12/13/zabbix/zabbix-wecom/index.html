<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>zabbix 警报推送至企业微信（图文版）</title><meta name="description" content="混迹在IT行业的小菜鸟"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="新增Python脚本# encoding: utf-8
import sys
import requests
import json
import os
import time
import re
 
url = &amp;#39;http://10.1.1.59/zabbix/api_jsonrpc.php&amp;#39;
headers = &amp;#123;&amp;#39;Content-Type&amp;#39;: &amp;#39;application/json-rpc&amp;#39;&amp;#125;
graph_path = &amp;#39;/data/zabbix/images/&amp;#39;  # 定义图片存储路径
graph_url = &amp;#39;http://10.1.1.59/zabbix/chart.php&amp;#39;  # 定义图表的url
.."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="YanTao的线上笔记本" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Almighty.Yantao's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">zabbix 警报推送至企业微信（图文版）</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9EPython%E8%84%9A%E6%9C%AC"><span class="toc-text">新增Python脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9ESH%E8%84%9A%E6%9C%AC"><span class="toc-text">新增SH脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AA%92%E4%BB%8B"><span class="toc-text">配置媒介</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1"><i class="tag post-item-tag">企业微信</i></a><a href="/tags/zabbix"><i class="tag post-item-tag">zabbix</i></a><a href="/tags/%E6%8A%A5%E8%AD%A6"><i class="tag post-item-tag">报警</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">zabbix 警报推送至企业微信（图文版）</h1><time class="has-text-grey" datetime="2022-12-13T07:05:23.172Z">2022-12-13</time><article class="mt-2 post-content"><h2 id="新增Python脚本"><a href="#新增Python脚本" class="headerlink" title="新增Python脚本"></a>新增Python脚本</h2><pre><code class="python"># encoding: utf-8
import sys
import requests
import json
import os
import time
import re
 
url = &#39;http://10.1.1.59/zabbix/api_jsonrpc.php&#39;
headers = &#123;&#39;Content-Type&#39;: &#39;application/json-rpc&#39;&#125;
graph_path = &#39;/data/zabbix/images/&#39;  # 定义图片存储路径
graph_url = &#39;http://10.1.1.59/zabbix/chart.php&#39;  # 定义图表的url
loginurl = &quot;http://10.1.1.59/zabbix/index.php&quot;  # 定义登录的url
 
 
def uploadImg(path,accessToken):
    #img_url = &quot;https://qyapi.weixin.qq.com/cgi-bin/webhook/upload_media?key=&quot; + key + &quot;&amp;type=file&quot;
    img_url = &quot;https://qyapi.weixin.qq.com/cgi-bin/media/uploadimg?access_token=&quot;+accessToken
    files = &#123;&#39;media&#39;: open(path, &#39;rb&#39;)&#125;
    r = requests.post(img_url, files=files)
    re = json.loads(r.text)
    print(re)
    return re[&#39;url&#39;]
 
 
def get_itemid(message):
    #print(message)
    itemid = re.search(r&#39;ITEMID:(\d+)&#39;, message).group(1)
    #itemid = 1
    return itemid
 
 
def get_imgUrl(itemid):
    session = requests.Session()
    try:
        loginheaders = &#123;
            &quot;Host&quot;: &quot;10.1.1.59&quot;,
            &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;
        &#125;
        # 定义请求消息头
 
        payload = &#123;
            &quot;name&quot;: &#39;yantao&#39;,
            &quot;password&quot;: &#39;xxxxxxx&#39;,
            &quot;autologin&quot;: &quot;1&quot;,
            &quot;enter&quot;: &quot;Sign in&quot;,
        &#125;
        # 定义传入的data
        login = session.post(url=loginurl, headers=loginheaders, data=payload)
        print(login)
        graph_params = &#123;
            &quot;from&quot;: &quot;now-10m&quot;,
            &quot;to&quot;: &quot;now&quot;,
            &quot;itemids&quot;: itemid,
            &quot;width&quot;: &quot;400&quot;,
        &#125;
        # 定义获取图片的参数
        graph_req = session.get(url=graph_url, params=graph_params)
        # 发送get请求获取图片数据
        time_tag = time.strftime(&quot;%Y%m%d%H%M%S&quot;, time.localtime())
        graph_name = &#39;baojing_&#39; + time_tag + &#39;.png&#39;
        # 用报警时间来作为图片名进行保存
        graph_name = os.path.join(graph_path, graph_name)
        # 使用绝对路径保存图片
        with open(graph_name, &#39;wb&#39;, ) as f:
            f.write(graph_req.content)
            # 将获取到的图片数据写入到文件中去
        return graph_name
    except Exception as e:
        print(e)
        return False
 
def getAccessToken():
    api_url = &quot;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=corpid&amp;corpsecret=corpsecret&quot;
    content = requests.get(api_url)
    #print(content.json())
    return content.json().get(&quot;access_token&quot;)
 
def getImgUrl(mediaId,accessToken):
    api_url = &quot;https://qyapi.weixin.qq.com/cgi-bin/media/get?access_token=&quot;+accessToken+&quot;&amp;media_id=&quot;+mediaId
    content = requests.get(api_url)
    print(mediaId)
    print(content.json())
    return content.json().get(&quot;url&quot;)
 
def send_message(imgUrl,title,desc,openUrl,key):
    # 发送消息
    url = &quot;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=&quot; + key
    # message = title  # sys.argv[3]
    params = &#123;
        &quot;msgtype&quot;: &quot;template_card&quot;,
        &quot;template_card&quot;: &#123;
            &quot;card_type&quot;: &quot;news_notice&quot;,
            &quot;source&quot;: &#123;
                &quot;desc&quot;: &quot;Zabbix网络警报&quot;,
                &quot;desc_color&quot;: 0
            &#125;,
            &quot;main_title&quot;:&#123;
                &quot;title&quot;:&quot;Zabbix网络警报&quot;,
            &#125;,
            &quot;quote_area&quot;:&#123;
                &quot;type&quot;:0,
                &quot;quote_text&quot;:desc
            &#125;,
            &quot;card_image&quot;: &#123;
                &quot;url&quot;: imgUrl
            &#125;,
            &quot;card_action&quot;: &#123;
                &quot;type&quot;: 1,
                &quot;url&quot;: openUrl,
                &quot;appid&quot;: &quot;APPID&quot;,
                &quot;pagepath&quot;: &quot;PAGEPATH&quot;
            &#125;
        &#125;
    &#125;
    req = requests.post(url, data=json.dumps(params))
    print(req.json())
 
 
if __name__ == &#39;__main__&#39;:
    message = sys.argv[1]
    print(message)
    itemid = get_itemid(message)
    imgpath = get_imgUrl(itemid)
    accessToken = getAccessToken();
    imgUrl = uploadImg(imgpath,accessToken)
    #print(itemid)
    #print(imgpath)
    print(imgUrl)
    send_message(imgUrl,sys.argv[2],sys.argv[3],imgUrl,sys.argv[4])
    #accessToken = getAccessToken()
</code></pre>
<h2 id="新增SH脚本"><a href="#新增SH脚本" class="headerlink" title="新增SH脚本"></a>新增SH脚本</h2><pre><code class="shell">#!/bin/bash
echo $1 &gt;&gt; /data/zabbix/log.log
python /usr/lib/zabbix/alertscripts/wxcom.py $1 $2 $3 $4
</code></pre>
<p>把两个文件都放到这个目录下：&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts&#x2F;</p>
<h2 id="配置媒介"><a href="#配置媒介" class="headerlink" title="配置媒介"></a>配置媒介</h2></article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/12/14/openvpn/openvpn-dynamic-route-permissions/" title="openvpn动态下发权限"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: openvpn动态下发权限</span></a><a class="button is-default" href="/2022/12/13/openvpn/openvpn-access-server/" title="安装&amp;破解Openvpn Access Server"><span class="has-text-weight-semibold">下一页: 安装&amp;破解Openvpn Access Server</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/almightyYantao"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Almighty.Yantao 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>